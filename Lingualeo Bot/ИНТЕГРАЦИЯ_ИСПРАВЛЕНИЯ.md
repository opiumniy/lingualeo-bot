# Исправление проблемы с маркировкой слов в Lingualeo Bot

## Описание проблемы

После успешной тренировки в Lingualeo Bot некоторые слова неправильно маркируются как "ошибленные" (is_error = 1), даже если пользователь правильно ответил на все вопросы тренировки. Это происходит из-за несогласованности типов данных, отправляемых на сервер.

**Причина проблемы:**
1. API Lingualeo ожидает, что `word_id` должен быть в строковом формате (string), а `translate_id` - в числовом формате (integer)
2. В существующем коде типы данных могут смешиваться - некоторые ID могут быть строками, а некоторые - числами
3. Это приводит к ошибкам на стороне сервера, и слова отмечаются как "ошибленные"

## Решение проблемы

Разработано две стратегии исправления проблемы:

### Вариант 1: Быстрое исправление (минимальные изменения)

Этот вариант не требует замены всего API-клиента, а только добавляет функцию-обертку, которая исправляет форматирование данных перед отправкой на сервер. Это самое простое и безопасное исправление для немедленного внедрения.

1. Скопируйте функцию `fix_existing_process_training_answer_batch` из файла `api_client_fixed.py` в конец вашего файла `api_client.py`

2. Замените все вызовы `client.process_training_answer_batch(training_results)` на  
   `fix_existing_process_training_answer_batch(client, training_results)`

   Например, в файле `tg_bot.py` найдите строку:
   ```python
   server_response = client.process_training_answer_batch(training_results)
   ```
   
   И замените её на:
   ```python
   server_response = fix_existing_process_training_answer_batch(client, training_results)
   ```

### Вариант 2: Полное исправление (замена API-клиента)

Этот вариант заменяет весь API-клиент на исправленную версию, которая автоматически обрабатывает преобразование типов во всех методах.

1. Переименуйте файл `api_client_fixed.py` в `api_client.py` (сделайте резервную копию оригинального файла)

2. Или замените только методы, отвечающие за тренировку, в существующем файле `api_client.py`:
   - `process_training_answer_batch`
   - `process_training_answer`
   - `process_training_answer_async`

## Тестирование исправления

Для проверки корректности исправления рекомендуется:

1. Запустить скрипт `test_fix.py`, чтобы убедиться, что данные правильно форматируются

2. Провести тренировку с реальным пользователем и убедиться, что все слова правильно отмечаются при успешной тренировке

## Подробности исправления

Исправление гарантирует, что перед отправкой данных на сервер:

```python
# Исходные данные могут иметь любые типы
training_results = {
    "123": "1",  # str -> str
    456: 2,      # int -> int
    789: "3",    # int -> str
    "012": 4     # str -> int
}

# После нормализации все ключи - строки, все значения - числа
normalized_results = {
    "123": 1,  # str -> int
    "456": 2,  # str -> int
    "789": 3,  # str -> int
    "012": 4   # str -> int
}
```

Это позволяет избежать проблем с неправильной маркировкой слов после успешной тренировки.

## Важные файлы

1. `api_client_fixed.py` - полностью исправленная версия API-клиента
2. `test_fix.py` - скрипт для тестирования исправления
3. `test_training_responses.py` - скрипт для анализа проблемы и проверки различных форматов данных